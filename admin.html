<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dark Cafe - لوحة التحكم</title>
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #121212; color: #ffffff; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 1200px; }
        h1 { text-align: center; color: #bb86fc; }
        #rooms-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; margin-top: 30px; }
        .room-card { border: 1px solid #333; border-radius: 8px; padding: 15px; text-align: center; transition: background-color 0.3s; }
        .room-card h3 { margin-top: 0; }
        .room-card p { margin-bottom: 10px; font-size: 0.9em; color: #ccc; }
        .room-card.Available { background-color: #004d40; border-color: #00796b; }
        .room-card.Busy { background-color: #b71c1c; border-color: #f44336; }
        .actions button {
            border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 14px; margin: 5px; font-weight: bold;
        }
        .actions button:hover { opacity: 0.8; }
        .start-btn { background-color: #03dac6; color: #000; }
        .end-btn { background-color: #cf6679; color: #000; }
        #loading { font-size: 1.2em; text-align: center; }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <h1>لوحة تحكم الكاشير</h1>
        <div id="rooms-grid">
            <p id="loading">جاري تحميل حالة الغرف...</p>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycby3b62wnm8yRJrNA54s0z4JTHOG7Gy4NG8iO4WDT0ErN4oVjDE2RrotHlKiJDVVayAJ/exec';

        const roomsGrid = document.getElementById('rooms-grid');

        async function fetchAndDisplayRooms() {
            roomsGrid.innerHTML = '<p id="loading">جاري تحديث حالة الغرف...</p>';
            try {
                const response = await fetch(API_URL);
                const rooms = await response.json();
                roomsGrid.innerHTML = '';
                if (rooms.error) throw new Error(rooms.message);
                if (rooms.length === 0) { roomsGrid.innerHTML = '<p>لا توجد بيانات غرف حاليًا.</p>'; return; }

                rooms.forEach(room => {
                    const card = document.createElement('div');
                    const statusClass = room.Status === 'Busy' ? 'Busy' : 'Available';
                    card.className = `room-card ${statusClass}`;
                    
                    card.innerHTML = `
                        <h3>${room.RoomName || 'غرفة غير مسماة'}</h3>
                        <p>الحالة: ${statusClass === 'Available' ? 'متاحة' : 'مشغولة'}</p>
                        <div class="actions"></div>
                    `;

                    const actionsDiv = card.querySelector('.actions');
                    if (statusClass === 'Available') {
                        const startButton = document.createElement('button');
                        startButton.textContent = 'ابدأ';
                        startButton.className = 'start-btn';
                        startButton.onclick = () => startSession(room.RoomID);
                        actionsDiv.appendChild(startButton);
                    } else {
                        const endButton = document.createElement('button');
                        endButton.textContent = 'إنهاء';
                        endButton.className = 'end-btn';
                        endButton.onclick = () => endSession(room.RoomID);
                        actionsDiv.appendChild(endButton);
                    }
                    
                    roomsGrid.appendChild(card);
                });

            } catch (error) {
                roomsGrid.innerHTML = `<p style="color: #f44336;">حدث خطأ في تحميل البيانات.</p>`;
            }
        }

        async function startSession(roomId) {
            if (!confirm(`هل أنت متأكد أنك تريد بدء جلسة للغرفة ${roomId}؟`)) return;
            await sendAction('startSession', roomId);
        }

        async function endSession(roomId) {
            if (!confirm(`هل أنت متأكد أنك تريد إنهاء جلسة الغرفة ${roomId}؟`)) return;
            await sendAction('endSession', roomId);
        }
        
        // دالة عامة مُحسَّنة لإرسال الأوامر وعرض أخطاء أفضل
        async function sendAction(actionName, roomId) {
             try {
                const urlWithParams = `${API_URL}?action=${actionName}&roomId=${roomId}`;
                const response = await fetch(urlWithParams);
                const result = await response.json();

                if (result.status === 'success') {
                    alert(result.message);
                    fetchAndDisplayRooms();
                } else {
                    // إذا كان هناك رسالة خطأ من السيرفر، اعرضها
                    throw new Error(result.message || JSON.stringify(result));
                }
            } catch (error) {
                // اعرض الخطأ الكامل الذي يحدث في المتصفح
                alert(`فشل الإجراء: ${error.toString()}`);
            }
        }

        fetchAndDisplayRooms();
        setInterval(fetchAndDisplayRooms, 60000); 
    </script>
</body>
</html>
