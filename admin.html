<script src="./config.js"></script>
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dark Cafe — لوحة الكاشير</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <style>
    *{box-sizing:border-box}
    body{font-family:'Tajawal',sans-serif;background:#121212;color:#fff;margin:0;padding:20px;display:flex;justify-content:center}
    .container{width:100%;max-width:1100px}
    h1{text-align:center;color:#bb86fc;margin:0 0 10px}
    .hint{color:#aaa;text-align:center;font-size:.9rem}
    #rooms-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px;margin-top:20px}
    .room-card{border:1px solid #333;border-radius:10px;padding:14px;text-align:center;transition:transform .15s ease,background-color .3s}
    .room-card:hover{transform:translateY(-2px)}
    .room-card.Available{background:#004d40;border-color:#00796b}
    .room-card.Busy{background:#5a1a1a;border-color:#f44336}
    .room-card h3{margin:0 0 8px}
    .room-card p{margin:0 0 10px;color:#ddd;font-size:.9rem}
    .actions button{border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-size:14px;margin:5px;font-weight:700}
    .start-btn{background:#03dac6;color:#000}
    .end-btn{background:#cf6679;color:#000}
    #loading{text-align:center;padding:24px}
  </style>
</head>
<body>
  <div class="container">
    <h1>لوحة تحكم الكاشير</h1>
    <div class="hint">ضع رابط الـ API في <code>config.js</code> · Web App: <b>Execute as: Me</b> + <b>Access: Anyone</b></div>
    <div id="rooms-grid"><p id="loading">جاري تحميل حالة الغرف…</p></div>
  </div>

  <!-- رابط الـ API -->
  <script src="./config.js"></script>
  <script>
    if (!window.API_URL) alert('⚠️ لم يتم ضبط API_URL في config.js');

    const roomsGrid=document.getElementById('rooms-grid');

    async function fetchAndDisplayRooms(){
      roomsGrid.innerHTML='<p id="loading">جاري تحديث حالة الغرف…</p>';
      try{
        const res=await fetch(API_URL, { method:'GET' });
        const rooms=await res.json();

        roomsGrid.innerHTML='';
        if(!Array.isArray(rooms)){ throw new Error('استجابة غير متوقعة من API'); }
        if(rooms.length===0){ roomsGrid.innerHTML='<p style="text-align:center">لا توجد غرف بعد.</p>'; return; }

        rooms.forEach(room=>{
          const busy = (room.Status==='Busy' || room.Status==='مشغولة');
          const statusClass = busy ? 'Busy' : 'Available';
          const card=document.createElement('div');
          card.className='room-card '+statusClass;
          card.innerHTML=`
            <h3>${room.RoomName || 'غرفة'}</h3>
            <p>الكود: ${room.RoomID || '-'}</p>
            <p>الحالة: ${busy ? 'مشغولة' : 'متاحة'}</p>
            <div class="actions"></div>`;
          const actionsDiv=card.querySelector('.actions');
          if(!busy){
            const btn=document.createElement('button');
            btn.className='start-btn'; btn.textContent='ابدأ';
            btn.onclick=()=>startSession(room.RoomID);
            actionsDiv.appendChild(btn);
          }else{
            const btn=document.createElement('button');
            btn.className='end-btn'; btn.textContent='إنهاء';
            btn.onclick=()=>endSession(room.RoomID);
            actionsDiv.appendChild(btn);
          }
          roomsGrid.appendChild(card);
        });
      }catch(e){
        roomsGrid.innerHTML='<p style="color:#f44336;text-align:center">تعذر تحميل البيانات.</p>';
        console.error(e);
      }
    }

    async function startSession(roomId){
      if(!roomId) return alert('RoomID غير معروف.');
      if(!confirm(`بدء جلسة للغرفة ${roomId}؟`)) return;
      await sendAction('startSession', roomId);
    }

    async function endSession(roomId){
      if(!roomId) return alert('RoomID غير معروف.');
      if(!confirm(`إنهاء جلسة الغرفة ${roomId}؟`)) return;
      await sendAction('endSession', roomId);
    }

    async function sendAction(actionName, roomId){
      try{
        const url=`$https://script.google.com/macros/s/AKfycbyyT_BavvpFvkJU_4MkSmVJ1VjL-WFq-Zi4lV5aenKCYH4kW-aeyBdjMYr9jg0nRLUh/exec`;
        const res=await fetch(url, { method:'GET' });
        const result=await res.json();
        if(result.status==='success'){
          alert(result.message);
          fetchAndDisplayRooms();
        }else{
          throw new Error(result.message || JSON.stringify(result));
        }
      }catch(err){
        alert('فشل الإجراء: '+err.toString());
        console.error(err);
      }
    }

    fetchAndDisplayRooms();
    setInterval(fetchAndDisplayRooms, 60000);
  </script>
</body>
</html>
