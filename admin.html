<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dark Cafe – لوحة التحكم</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Tajawal', sans-serif;
      background: #121212;
      color: #fff;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      text-align: center;
      color: #bb86fc;
    }
    .hint {
      color: #aaa;
      text-align: center;
      font-size: .9rem;
      margin-bottom: 15px;
    }
    #rooms {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 16px;
      width: 100%;
      max-width: 1000px;
      margin-top: 20px;
    }
    .room {
      background: #1e1e1e;
      border-radius: 10px;
      padding: 16px;
      text-align: center;
      transition: 0.3s;
    }
    .room.available { border: 2px solid #03dac6; }
    .room.occupied { border: 2px solid #cf6679; }
    .room:hover { transform: scale(1.03); }
    button {
      background: #03dac6;
      border: none;
      color: #000;
      padding: 8px 12px;
      margin-top: 8px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    button.end { background: #cf6679; color: #fff; }
  </style>
</head>
<body>
  <h1>لوحة تحكم الكاشير</h1>
  <p class="hint">
    تأكد من إعدادات API في ملف config.js | Web App: Execute as: Me + Access: Anyone
  </p>
  <div id="rooms">جاري تحميل حالة الغرف...</div>

  <!-- ✅ هنا تعديل سطر استيراد config -->
<script src="./config.js?v=5"></script>

  <script>
    async function fetchRooms() {
      if (typeof API_URL === 'undefined' || !API_URL) {
        alert('⚠️ لم يتم ضبط API_URL في config.js');
        return;
      }

      try {
        const res = await fetch(API_URL);
        const data = await res.json();

        if (!Array.isArray(data)) {
          document.getElementById('rooms').innerHTML =
            '<p style="color:red;">استجابة غير متوقعة من API.</p>';
          console.error('Unexpected:', data);
          return;
        }

        displayRooms(data);
      } catch (err) {
        document.getElementById('rooms').innerHTML =
          '<p style="color:red;">حدث خطأ أثناء تحميل البيانات.</p>';
        console.error(err);
      }
    }

    function displayRooms(rooms) {
      const container = document.getElementById('rooms');
      container.innerHTML = '';

      rooms.forEach(room => {
        const div = document.createElement('div');
        div.className = 'room ' + (room.Status === 'Available' ? 'available' : 'occupied');
        div.innerHTML = `
          <h3>${room.RoomName}</h3>
          <p>${room.Type}</p>
          <p>الحالة: ${room.Status}</p>
          ${
            room.Status === 'Available'
              ? `<button onclick="sendAction('startSession','${room.RoomID}')">ابدأ</button>`
              : `<button class="end" onclick="sendAction('endSession','${room.RoomID}')">إنهاء</button>`
          }
        `;
        container.appendChild(div);
      });
    }

    async function sendAction(actionName, roomId) {
      try {
        const url = `${API_URL}?action=${encodeURIComponent(actionName)}&roomId=${encodeURIComponent(roomId)}`;
        const res = await fetch(url, { method: 'GET' });
        const result = await res.json();

        if (result.status === 'success') {
          alert(result.message);
          fetchRooms();
        } else {
          alert('⚠️ خطأ: ' + result.message);
        }
      } catch (err) {
        alert('حدث خطأ أثناء الاتصال بالسيرفر');
        console.error(err);
      }
    }

    fetchRooms();
  </script>
</body>
</html>
